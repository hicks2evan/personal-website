









<!doctype html>
<html class="min-height-full">
  <head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-99594255-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-99594255-3');
    </script>

    <meta charset="utf-8">
    <title>Are you Moqing me?</title>
    <meta name="description" content="When I was looking for my first job in software I interviewed with a company who had me build a simple web application as a take-home section of the interview. I did what I had learned to do in my classes and in my personal projects- fork their interview repo, run a scaffolding generator (Yeoman ..." />
    <meta property="og:title" content="Are you Moqing me?" />
    <meta property="og:image" content="https://hicks2evan.github.io/assets/images/featured/2020-07-15.png" />
    <meta property="og:description" content="When I was looking for my first job in software I interviewed with a company who had me build a simple web application as a take-home section of the interview. I did what I had learned to do in my classes and in my personal projects- fork their interview repo, run a scaffolding generator (Yeoman ..." />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="/assets/styles.css" rel="stylesheet" type="text/css">
  </head>
  <body class="bg-white min-height-full" >





  <div class="container-lg py-6 p-responsive text-center">
    

<img src="https://avatars.githubusercontent.com/u/23247607?v=4" class="circle mb-3" style="max-width: 150px;">
<h1 class=" mb-2 lh-condensed">Evan Hicks</h1>




    <div class="container-md f4 text-left border rounded-2 bg-white p-3 p-sm-5 mt-6">
      <p class="f5"><a href="/" class="d-flex flex-items-center"><svg height="16" class="octicon octicon-chevron-left mr-2 v-align-middle" fill="#0366d6" aria-label="Home" viewBox="0 0 16 16" version="1.1" width="16" role="img"><path fill-rule="evenodd" d="M9.78 12.78a.75.75 0 01-1.06 0L4.47 8.53a.75.75 0 010-1.06l4.25-4.25a.75.75 0 011.06 1.06L6.06 8l3.72 3.72a.75.75 0 010 1.06z"></path></svg>Home</a></p>
      
      <img src="/assets/images/featured/2020-07-15.png" class="mx-auto rounded-1 mb-3" alt="featured/2020-07-15.png">
      
      <h1 class="f00-light lh-condensed">Are you Moqing me?</h1>
      <h2>C# unit testing with moq</h2>
      <p class="text-gray mb-5">Published Jul 15, 2020</p>
      
  
    

    

    

    
      <div class="col-sm-4 col-lg-3 d-flex flex-wrap flex-items-center d-sm-block float-sm-right border rounded-2 bg-white p-3 mb-5 ml-md-5">
        <h3 class="text-gray-dark mr-3 mr-sm-0">Share</h3>
        <ul class="d-flex d-sm-block list-style-none">
          
            <li class="mt-sm-3">
              <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2F2020%2F07%2F15%2Fare-you-moqing-me%2F" title="Share on LinkedIn" class="d-flex flex-items-center">
                <div style="width:32px"><svg height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19 18"><path d="M3.94 2A2 2 0 1 1 2 0a2 2 0 0 1 1.94 2zM4 5.48H0V18h4zm6.32 0H6.34V18h3.94v-6.57c0-3.66 4.77-4 4.77 0V18H19v-7.93c0-6.17-7.06-5.94-8.72-2.91z" fill="#959da5"/></svg></div><span class="d-none d-sm-inline-block text-gray-light">LinkedIn</span>
              </a>
            </li>
          
            <li class="mt-sm-3">
              <a href="https://twitter.com/share?url=http%3A%2F%2Flocalhost%3A4000%2F2020%2F07%2F15%2Fare-you-moqing-me%2F" title="Share on Twitter" class="d-flex flex-items-center">
                <div style="width:32px"><svg height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 273.5 222.3"><path d="M273.5 26.3a109.77 109.77 0 0 1-32.2 8.8 56.07 56.07 0 0 0 24.7-31 113.39 113.39 0 0 1-35.7 13.6 56.1 56.1 0 0 0-97 38.4 54 54 0 0 0 1.5 12.8A159.68 159.68 0 0 1 19.1 10.3a56.12 56.12 0 0 0 17.4 74.9 56.06 56.06 0 0 1-25.4-7v.7a56.11 56.11 0 0 0 45 55 55.65 55.65 0 0 1-14.8 2 62.39 62.39 0 0 1-10.6-1 56.24 56.24 0 0 0 52.4 39 112.87 112.87 0 0 1-69.7 24 119 119 0 0 1-13.4-.8 158.83 158.83 0 0 0 86 25.2c103.2 0 159.6-85.5 159.6-159.6 0-2.4-.1-4.9-.2-7.3a114.25 114.25 0 0 0 28.1-29.1" fill="#959da5"/></svg></div><span class="d-none d-sm-inline-block text-gray-light">Twitter</span>
              </a>
            </li>
          
        </ul>
      </div>
    
  
  <div class="article">
    <p>When I was looking for my first job in software I interviewed with a company who had me build a simple web application as a take-home section of the interview. I did what I had learned to do in my classes and in my personal projects- fork their interview repo, run a scaffolding generator (<a href="https://yeoman.io/">Yeoman</a> for Angular, which I would still recommend) and code, code, code!</p>

<p><img src="/assets/images/posts/2020-07-15/1.png" alt="Hand-drawn Yeoman logo" /></p>

<p>The interviewers reviewed my project with me on the phone. They liked how I had things organized and how I had reused my Angular components throughout the site- but then they had a question. <strong>What’s in the test directory? How does this test code work? Can you tell us the difference between a unit test and an integration test?</strong></p>

<p>Like many students, I had been given a few privileged opportunities to be exposed to software testing:</p>
<ol>
  <li>I had taken a course called “Software Engineering I” at my university which covered testing as a topic along with UML, non-technical requirements, and the like.</li>
  <li>I had probably read a Medium article espousing TDD as the <em>only way</em> to write quality software.</li>
  <li>I had an internship at an organization that <em>had</em> unit tests, even if my intern project <em>did not</em>.</li>
</ol>

<blockquote>
  <p><em>“Well, a unit test is designed to test just a section of the code, when the integration test is responsible for testing how things wire together, right?”</em></p>
</blockquote>

<blockquote>
  <p><em>“Ok. For the sections of the code that aren’t being tested in a unit test, how do you simulate them? How do you make sure the unit of code you are testing has what it needs to do its job?”</em></p>
</blockquote>

<p>My test directory didn’t have anything but the default yeoman-generated <a href="https://mochajs.org/">Mocha</a> tests. I hadn’t run npm test in my development. And not too surprisingly, I didn’t end up getting an offer.</p>

<h1 id="so-what-were-they-asking-about">So, what were they asking about?</h1>

<p>If you’ve been working in software for some time, or you are a student who has prepared for this type of interview better than I had, you have probably seen an illustration like this:</p>

<p><img src="/assets/images/posts/2020-07-15/2.png" alt="Puzzle pieces with disguises" /></p>

<p>But that puzzle piece illustration is boring. I actually like to think of it more as a <a href="https://www.amazon.com/Mr-Potato-Head-Story-Classic/dp/B003C1MW4Q">Mr. Potato head doll</a>. Your unit tests are all about running the code that can be represented as just one piece of Mr. Potato head. Like his mustache, or his plump potato body.</p>

<p><img src="/assets/images/posts/2020-07-15/3.png" alt="Disassembled Mr. Potato Head" /></p>

<p>In object oriented land, that one Mr. Potato piece is a <em>class</em>. An instance of the class or an object is constructed in your code at runtime with everything that it needs.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">MrPotatoHead</span> <span class="p">{</span>
    <span class="k">private</span> <span class="n">IHat</span> <span class="n">hat</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">IArm</span><span class="p">[]</span> <span class="n">arms</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">MrPotatoHead</span><span class="p">(</span><span class="n">IHat</span> <span class="n">hat</span><span class="p">,</span> <span class="n">IArm</span> <span class="n">leftArm</span><span class="p">,</span> <span class="n">IArm</span> <span class="n">rightArm</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">hat</span> <span class="p">=</span> <span class="n">hat</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">arms</span> <span class="p">=</span> <span class="k">new</span> <span class="n">IArm</span><span class="p">[]</span> <span class="p">{</span><span class="n">leftArm</span><span class="p">,</span> <span class="n">rightArm</span><span class="p">};</span>

        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"I'm a new potato!"</span><span class="p">);</span>

        <span class="n">hat</span><span class="p">.</span><span class="nf">Tip</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Wave</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">arms</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="nf">Wave</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>In this case, Mr. Potato Head’s body needs a left arm, right arm, and a hat. It also could need things like eyes, a nose, ears, a mustache, and a pair of shoes. In UML-speak:</p>

<p><img src="/assets/images/posts/2020-07-15/4.png" alt="Mr. Potato Head UML Class Diagram" /></p>

<p>The point they were trying to get at in my interview was that in a unit test you should only be <em>instantiating</em> the code you are testing, and <em>mocking</em> the code that you aren’t testing.</p>

<p>A mock simulates the functionality of the code your unit test depends on, but doesn’t implement it. Kind of like sticking a shoelace in the hole where Mr. Potato Head’s left arm goes. It isn’t a left arm, it’s just able to connect to the potato body <em>like a left arm</em>.</p>

<p><img src="/assets/images/posts/2020-07-15/5.png" alt="Mr. Potato Head other objects inserted" /></p>

<p>So how is this handled in code? Most unit tests use some kind of mocking framework. In C# you can use moq to mock classes based off of what methods are laid out in their interfaces. Just like inserting a shoelace in Mr. Potato Head’s arm hole, if LeftArm implements the IArm interface, then I can mock IArm and pass it as a parameter to the MrPotatoHead class to test.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="p">[</span><span class="n">TestClass</span><span class="p">]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">MrPotatoHeadTest</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">MrPotatoHead</span> <span class="n">mrPotatoHead</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IArm</span><span class="p">&gt;</span> <span class="n">leftArm</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IArm</span><span class="p">&gt;();</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IArm</span><span class="p">&gt;</span> <span class="n">rightArm</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IArm</span><span class="p">&gt;();</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IHat</span><span class="p">&gt;</span> <span class="n">hat</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IHat</span><span class="p">&gt;();</span>

    <span class="k">public</span> <span class="nf">MrPotatoHeadTest</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">mrPotatoHead</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MrPotatoHead</span><span class="p">(</span>
            <span class="n">hat</span><span class="p">.</span><span class="n">Object</span><span class="p">,</span> 
            <span class="n">leftArm</span><span class="p">.</span><span class="n">Object</span><span class="p">,</span> 
            <span class="n">rightArm</span><span class="p">.</span><span class="n">Object</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="p">[</span><span class="n">TestMethod</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">MrPotatoHeadWaves_RightArmShouldWave</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">mrPotatoHead</span><span class="p">.</span><span class="nf">Wave</span><span class="p">();</span>

        <span class="n">leftArm</span><span class="p">.</span><span class="nf">Verify</span><span class="p">(</span><span class="n">l</span> <span class="p">=&gt;</span> <span class="n">l</span><span class="p">.</span><span class="nf">Wave</span><span class="p">(),</span> <span class="n">Times</span><span class="p">.</span><span class="nf">Never</span><span class="p">());</span>
        <span class="n">rightArm</span><span class="p">.</span><span class="nf">Verify</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="n">r</span><span class="p">.</span><span class="nf">Wave</span><span class="p">(),</span> <span class="n">Times</span><span class="p">.</span><span class="nf">Once</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<h1 id="why-is-this-useful">Why is this useful?</h1>

<p>Next question is how this is going to provide value to us in our testing. The first easy answer is that it lets the test focus on just one section of the code. Let’s say you introduced a bug that is causing the wrong value to be returned to the user from the database. There are a lot of classes in-between, how do you tell where the issue is?</p>

<p><img src="/assets/images/posts/2020-07-15/6.png" alt="Mr. Potato Head browsing website, error loading potato" /></p>

<p>Speaking of that database, maybe we don’t want our test code (which we run regularly to get feedback on the small incremental code we have written) to have to integrate with external systems. Mocking allows us to set up scenarios with our interfaces as a point of delineation.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="p">[</span><span class="n">TestMethod</span><span class="p">]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">CreatePotato_Success_ReturnsId</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//Setup mock provider</span>
    <span class="kt">int</span> <span class="n">returnId</span> <span class="p">=</span> <span class="m">12345</span><span class="p">;</span>
    <span class="n">dbProvider</span><span class="p">.</span><span class="nf">Setup</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="nf">CreatePotato</span><span class="p">(</span><span class="n">It</span><span class="p">.</span><span class="n">IsAny</span><span class="p">&lt;</span><span class="n">IPotato</span><span class="p">&gt;())).</span><span class="nf">Returns</span><span class="p">(</span><span class="n">returnId</span><span class="p">);</span>

    <span class="c1">//Call real controller code</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="p">=</span> <span class="n">potatoController</span><span class="p">.</span><span class="nf">CreateNewPotato</span><span class="p">(</span><span class="s">"Lieutenant J.D. Potato"</span><span class="p">);</span>

    <span class="c1">//Check what happened</span>
    <span class="n">Assert</span><span class="p">.</span><span class="nf">AreEqual</span><span class="p">(</span><span class="n">returnId</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
    <span class="n">dbProvider</span><span class="p">.</span><span class="nf">Verify</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="nf">CreatePotato</span><span class="p">(</span><span class="n">It</span><span class="p">.</span><span class="n">IsAny</span><span class="p">&lt;</span><span class="n">IPotato</span><span class="p">&gt;()),</span> <span class="n">Times</span><span class="p">.</span><span class="n">Once</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>In this code we mock a database provider, and any scenario we want for some state of data that could be returned from the database can be configured through this mock. No test data setup or teardown.</p>

<p>Finally, mocking doesn’t just let you specify how your simulated dependencies should behave. It also lets you check in on how the code you are testing is behaving with those dependencies. Let’s say your code also has to write files to some persistent file store.</p>

<p><img src="/assets/images/posts/2020-07-15/7.png" alt="Website to profile json file to potato profile file store" /></p>

<p>How can you check in your test if the contents of the file your code writes are correct? You could just instantiate your file writer, but then you are testing two pieces of functionality at once, not good!</p>

<p>In Moq you can also verify that methods are called on your mock with parameters that meet certain criteria, as well as how many times they are called.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="p">[</span><span class="n">TestMethod</span><span class="p">]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">WritePotatoProfile_Success_ReturnsId</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//Setup mock provider</span>
    <span class="kt">int</span> <span class="n">returnId</span> <span class="p">=</span> <span class="m">12345</span><span class="p">;</span>
    <span class="n">filestoreProvider</span><span class="p">.</span><span class="nf">Setup</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="nf">WritePotatoFile</span><span class="p">(</span><span class="n">It</span><span class="p">.</span><span class="n">IsAny</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;())).</span><span class="nf">Returns</span><span class="p">(</span><span class="n">returnId</span><span class="p">);</span>

    <span class="c1">//Call real controller code</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="p">=</span> <span class="n">potatoController</span><span class="p">.</span><span class="nf">WriteProfile</span><span class="p">(</span>
        <span class="s">"Darth Potato"</span><span class="p">,</span> 
        <span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span><span class="s">"the force"</span><span class="p">,</span> <span class="s">"fast food"</span><span class="p">},</span> 
        <span class="s">"I am a sith lord potato lookin' for love."</span>
    <span class="p">);</span>

    <span class="c1">//Check what happened</span>
    <span class="n">Assert</span><span class="p">.</span><span class="nf">AreEqual</span><span class="p">(</span><span class="n">returnId</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
    <span class="n">filestoreProvider</span><span class="p">.</span><span class="nf">Verify</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="nf">WritePotatoFile</span><span class="p">(</span><span class="n">It</span><span class="p">.</span><span class="n">Is</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="n">s</span> <span class="p">=&gt;</span> 
        <span class="n">s</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"the force"</span><span class="p">)</span> <span class="p">&amp;&amp;</span> 
        <span class="n">s</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"Darth Potato"</span><span class="p">))),</span> <span class="n">Times</span><span class="p">.</span><span class="n">Once</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>So if you are expecting your code to write 5 files containing potato dating bios, you can precisely verify that it is.</p>

<h1 id="what-could-go-wrong">What could go wrong?</h1>
<h2 id="1-your-unit-tests-only-test-the-happy-path">1. Your unit tests only test the happy path</h2>
<p><img src="/assets/images/posts/2020-07-15/8.png" alt="Mr. Potato Head fallen apart" /></p>

<p>In general your tests should probably test the happy path, an edge case scenario, and an exception case at least. Writing tests for your exception scenarios will help you better understand how your code responds to exceptions and verify that it behaves correctly. In Moq, you can mock exceptions to simulate the expected exceptions in your system.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="p">[</span><span class="n">TestMethod</span><span class="p">]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">CreatePotato_Failure_ReturnsNegative</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//Setup mock provider with exception</span>
    <span class="n">dbProvider</span><span class="p">.</span><span class="nf">Setup</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="nf">CreatePotato</span><span class="p">(</span><span class="n">It</span><span class="p">.</span><span class="n">IsAny</span><span class="p">&lt;</span><span class="n">IPotato</span><span class="p">&gt;())).</span><span class="nf">Throws</span><span class="p">(</span>
        <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="nf">Exception</span><span class="p">(</span><span class="s">"database timed out"</span><span class="p">));</span>

    <span class="c1">//Call real controller code</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="p">=</span> <span class="n">potatoController</span><span class="p">.</span><span class="nf">CreateNewPotato</span><span class="p">(</span><span class="s">"Lieutenant J.D. Potato"</span><span class="p">);</span>

    <span class="c1">//Check what happened</span>
    <span class="n">Assert</span><span class="p">.</span><span class="nf">AreEqual</span><span class="p">(-</span><span class="m">1</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>You can even assert on the contents of the exception, this may be a bit extreme but if somebody changed an exception message, it would be caught by the test!</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="p">[</span><span class="n">TestMethod</span><span class="p">]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">WritePotatoProfile_Failure_ThrowsException</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">expectedException</span> <span class="p">=</span> <span class="s">"Something bad happened when trying to write the file."</span><span class="p">;</span>

    <span class="c1">//Setup mock provider</span>
    <span class="n">filestoreProvider</span><span class="p">.</span><span class="nf">Setup</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="nf">WritePotatoFile</span><span class="p">(</span><span class="n">It</span><span class="p">.</span><span class="n">IsAny</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;())).</span><span class="nf">Throws</span><span class="p">(</span>
        <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="nf">Exception</span><span class="p">(</span><span class="s">"file contained bad data"</span><span class="p">));</span>

    <span class="c1">//Call real controller code</span>
    <span class="kt">var</span> <span class="n">exception</span> <span class="p">=</span> <span class="n">Assert</span><span class="p">.</span><span class="n">ThrowsException</span><span class="p">&lt;</span><span class="n">System</span><span class="p">.</span><span class="n">Exception</span><span class="p">&gt;(()</span> <span class="p">=&gt;</span> <span class="n">potatoController</span><span class="p">.</span>
    <span class="nf">WriteProfile</span><span class="p">(</span>
        <span class="s">"Darth Potato"</span><span class="p">,</span> 
        <span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span><span class="s">"the force"</span><span class="p">,</span> <span class="s">"fast food"</span><span class="p">},</span> 
        <span class="s">"I am a sith lord potato lookin' for love."</span>
    <span class="p">));</span>

    <span class="c1">//Check what happened</span>
    <span class="n">Assert</span><span class="p">.</span><span class="nf">AreEqual</span><span class="p">(</span><span class="n">expectedException</span><span class="p">,</span> <span class="n">exception</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<h2 id="2-your-tests-dont-assert-anything-meaningful">2. Your tests don’t assert anything meaningful</h2>

<p>Your unit tests should provide value and increase confidence in the quality of your software. This is more of an issue of assertions than mocking, but your tests should assert something meaningful about the contents of what you are testing.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="p">[</span><span class="n">TestMethod</span><span class="p">]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">MeaninglessTest</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//Setup mock provider</span>
    <span class="kt">int</span> <span class="n">potatoId</span> <span class="p">=</span> <span class="m">12345</span><span class="p">;</span>
    <span class="n">Potato</span> <span class="n">returnPotato</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Potato</span><span class="p">();</span>
    <span class="n">dbProvider</span><span class="p">.</span><span class="nf">Setup</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="nf">GetPotato</span><span class="p">(</span><span class="n">potatoId</span><span class="p">)).</span><span class="nf">Returns</span><span class="p">(</span><span class="n">returnPotato</span><span class="p">);</span>

    <span class="c1">//Call real controller code</span>
    <span class="n">IPotato</span> <span class="n">result</span> <span class="p">=</span> <span class="n">potatoController</span><span class="p">.</span><span class="nf">GetPotato</span><span class="p">(</span><span class="n">potatoId</span><span class="p">);</span>

    <span class="c1">//No assertions</span>
    <span class="c1">//What happened? Who knows? The test passes.</span>
<span class="p">}</span></code></pre></figure>

<p>These assertions do little more than the compiler is doing on its own, and will pass even if the code doesn’t work as designed. Not good. A test is only as good as its assertions.</p>

<h2 id="3-your-test-code-is-more-code-than-test">3. Your test code is more <em>code</em> than test</h2>
<p><img src="/assets/images/posts/2020-07-15/9.png" alt="Mr. Potato Heads side by side stolen arm" /></p>

<p>Your test code doesn’t need super smart implementation like your code does. This sounds obvious, but it is a pretty easy mistake. The most heinous example is copying implementation code to help you calculate what you expect for your test. Imagine you had a silly little method to calculate some number.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="kt">double</span> <span class="nf">CalculatePotatoNumber</span><span class="p">(</span><span class="kt">int</span> <span class="n">input</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">someSillyNumber</span> <span class="p">=</span> <span class="m">12345</span> <span class="p">*</span> <span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="nf">Floor</span><span class="p">(</span><span class="n">input</span> <span class="p">+</span> <span class="n">input</span> <span class="p">*</span> <span class="p">(</span><span class="m">0.9</span><span class="p">)));</span>
    <span class="k">return</span> <span class="n">someSillyNumber</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>Then you make a test helper method to help you calculate the expected result.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="p">[</span><span class="n">TestMethod</span><span class="p">]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">CalculatePotatoNumber_100</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">double</span> <span class="n">expectedPotatoNumber</span> <span class="p">=</span> <span class="nf">GetExpectedPotatoNumber</span><span class="p">(</span><span class="m">100</span><span class="p">);</span>
    <span class="kt">double</span> <span class="n">result</span> <span class="p">=</span> <span class="n">mrPotatoHead</span><span class="p">.</span><span class="nf">CalculatePotatoNumber</span><span class="p">(</span><span class="m">100</span><span class="p">);</span>
    <span class="n">Assert</span><span class="p">.</span><span class="nf">AreEqual</span><span class="p">(</span><span class="n">expectedPotatoNumber</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="kt">double</span> <span class="nf">GetExpectedPotatoNumber</span><span class="p">(</span><span class="kt">int</span> <span class="n">input</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">someSillyNumber</span> <span class="p">=</span> <span class="m">12345</span> <span class="p">*</span> <span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="nf">Floor</span><span class="p">(</span><span class="n">input</span> <span class="p">+</span> <span class="n">input</span> <span class="p">*</span> <span class="p">(</span><span class="m">0.9</span><span class="p">)));</span>
    <span class="k">return</span> <span class="n">someSillyNumber</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>Really, if the PotatoNumber formula was typed in incorrectly, it won’t have been caught. It seems like we did something smart and made something reusable, but that isn’t always the goal in tests. The purpose would have been better served by just hard coding a few expected outcomes.</p>

<p>When I first came out of school, I felt like code was only “good” if it did something. Hard-coded values were “bad”. In this case it is actually much better to hard-code what you expect and validate against that. If you have a bug and your test is dumb, it will catch it instead of replicating it.</p>

<h2 id="4-your-dependencies-are-really-hard-to-mock">4. Your dependencies are really hard to mock</h2>

<p>When does mocking code break down? Usually when the code you are trying to test has a lot of responsibility and calls its dependencies in a lot of different ways. Or maybe your code depends on a class that is really hard to mock… like some kind of in house static class for bitmap formatting. Gnarly, dude! In my experience, this is usually more of a code organization issue. Common appearances in the wild:</p>

<ul>
  <li><em>I need to mock a gazillion methods in my utility class for any class that depends on it to work!</em>- Read up on SOLID design principles, specifically <a href="https://en.wikipedia.org/wiki/Single-responsibility_principle">single-responsibility principle</a>.</li>
  <li><em>I can’t mock a private method?</em>- Why is the method that your code needs private? Should there be another point of entry for your test code?</li>
  <li><em>I can’t mock a static method? Oh no!</em>- Read <a href="https://softwareengineering.stackexchange.com/questions/148049/how-to-deal-with-static-utility-classes-when-designing-for-testability?rq=1">this stack exchange</a>, think about whether or not your static method really needs to be mocked. You may just want to let your static dependency do its job.</li>
</ul>

<p>In object-oriented development, if your code is easily mocked and tested, you will also find that it becomes more organized, composable, and self-contained.</p>

<h1 id="you-dont-need-to-be-a-tdd-guru-to-write-meaningful-unit-tests">You don’t need to be a TDD guru to write meaningful unit tests</h1>
<p><img src="/assets/images/posts/2020-07-15/10.png" alt="Mr. Potato Head mountain guru" /></p>

<p>Your code base doesn’t need to have 100% code coverage, even if it does it probably won’t have 100% scenario coverage. Those are just statistics for your management to put in a slide deck. The biggest takeaway I had from learning how to use Moq for my C# code was simple:</p>

<blockquote>
  <p><em>Writing code with your mocks and tests in mind helps you write cleaner code.</em></p>
</blockquote>

<blockquote>
  <p><em>Covering your code base with meaningful unit tests will give you increased confidence to continue to make changes as your code base grows.</em></p>
</blockquote>

<blockquote>
  <p><em>Breath in. Breath out.</em></p>
</blockquote>

    <p>A code example project for this article can be found <a href="https://github.com/hicks2evan/blog-code-examples/tree/master/2020-07-15">here</a>.</p>
  </div>

    </div>
  </div>


    <div class="footer">
      <a href="/about">About Evan</a> |
      <a href="/assets/documents/Hicks_Evan_Resume.pdf" target="_blank">Resume</a>
    </div>
  </body>
</html>

